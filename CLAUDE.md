# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Common Commands / 常用命令

```powershell
# Install dependencies / 安装依赖
pip install streamlit openai python-dotenv pdfplumber python-docx pyyaml httpx fastapi uvicorn

# Run Public Access (Web + API + Tunnel) / 启动公网访问 (推荐)
.\run_public_access.bat

# Configure Cloudflare Tunnel / 配置隧道
.\setup_tunnel.ps1

# Run Web UI (React) / 运行Web界面
cd frontend-web; pnpm dev

# Run API Server (Local) / 运行本地API服务
python -m uvicorn src.api_server:app --reload

# Run all tests / 运行所有测试
pytest tests/ -v
```

---

## Architecture / 架构

**TalentOS v1.0** - Hybrid Architecture with FastAPI Backend and React Frontend, exposed via Cloudflare Tunnel.

### Components / 组件

```
src/
├── api_server.py         # FastAPI Backend (Port 8000) - REST API for analysis
├── core/                 # Core Business Logic (Engine, Config)
└── plugins/              # Plugin System (LLM, Parsers, Storage)
frontend-web/             # React Frontend (Port 8501)
```

### Deployment / 部署 (Cloudflare Tunnel)

*   **Domain**: `https://bmwuv.com`
*   **Tunnel Config**: `tunnel_config.yml` (Auto-generated by `setup_tunnel.ps1`)
*   **Routing**:
    *   `/` -> React Frontend (localhost:8501)
    *   `/analyze` -> FastAPI (localhost:8000)

---

## Usage / 使用

```python
from src.core.engine import create_engine

engine = create_engine()

# Resume vs JD analysis (returns AnalysisResult)
result = engine.analyze(resume_text, jd_text, persona="hrbp")
# result.report (str), result.score (0-100), result.tokens_used, result.cached

# Deep diagnostic (no JD, identifies hidden value)
result = engine.diagnose_resume(resume_text, persona="hrbp")

# Batch processing
results = engine.batch_analyze(resumes_list, jd_text, show_progress=True)

# Document parsing
doc = engine.parse_document("resume.pdf")  # ParsedDocument

# Runtime provider switch
engine.set_llm_provider("openai")
```

### Personas / 人设
- `hrbp` - Senior HRBP (strict, results-oriented, default)
- `coach` - Career Coach (friendly, supportive)
- `product_manager` - Senior PM (strategic, data-driven)

---

## Configuration / 配置

**Config File**: `config/config.yaml`
- `llm_providers`: DeepSeek (default), OpenAI, Anthropic
- `storage`: `local` (file cache in `cache/`) or `memory`, TTL=3600s
- `analysis.personas`: Custom system prompts

**Environment**: `.env` in project root
```text
DEEPSEEK_API_KEY="sk-..."
# OPENAI_API_KEY="sk-..."
# ANTHROPIC_API_KEY="sk-ant-..."
```

### Caching
- **Key**: MD5 of `{resume}:{jd}:{persona}`
- **Retry**: Exponential backoff (max 3 attempts)

---

## Adding Plugins / 添加插件

1. Create `src/plugins/<category>/<name>.py` implementing the interface (`ILLMProvider`, `IDocumentParser`, or `IStorage`)
2. Register in `src/plugins/<category>/__init__.py`
3. Enable in `config/config.yaml`

---

## Legacy API / 旧版API

Integration tests use legacy API for backward compatibility:
```python
from talentos import TalentOS
sniper = TalentOS()
report = sniper.analyze(resume, jd)
```

---

## Troubleshooting / 故障排查

### "引擎未初始化" 错误
LLM provider init failed. Check:
1. `.env` has valid `DEEPSEEK_API_KEY`
2. Network/proxy: `pip install httpx` for proxy support
3. Test: `curl -s "https://api.deepseek.com/models" -H "Authorization: Bearer $KEY"`

### "multiple values for keyword argument 'model'"
Fixed in v1.3 - `engine.py` uses `kwargs.pop()` to prevent duplicate params.

### Connection error with proxy
Install `httpx`: `pip install httpx` - enables proxy support in `deepseek.py`

### Cloudflare Tunnel Issues
1. **Domain Mismatch (seeingpure.com)**:
   - **Cause**: Cloudflare account missing `bmwuv.com` or local cert outdated.
   - **Fix**: Add domain to Dashboard -> Change Nameservers (Aliyun) -> `cloudflared tunnel login`.

2. **Streamlit 404 / Connection Error**:
   - **Cause**: CORS/XSRF protection blocking Tunnel requests.
   - **Fix**: Run with `--server.enableCORS false --server.enableXsrfProtection false` (Included in `run_public_access.bat`).

3. **Tunnel ID Mismatch**:
   - **Cause**: `setup_tunnel.ps1` using old tunnel ID.
   - **Fix**: Script now auto-detects correct UUID. Re-run `setup_tunnel.ps1`.


